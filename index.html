<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RUB → CNY + отправка в Google Form</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; max-width: 760px; margin: 32px auto; padding: 0 16px; }
    label { display:block; margin: 12px 0 6px; }
    input, select { width: 100%; padding: 10px; font-size: 16px; }
    button { margin-top: 16px; padding: 12px 14px; font-size: 16px; cursor: pointer; }
    .box { background:#f6f6f6; padding: 14px; border-radius: 12px; margin-top: 16px; }
    .row { display:flex; gap: 12px; align-items:flex-start; flex-wrap: wrap; }
    .row > * { flex: 1; min-width: 220px; }
    pre { white-space: pre-wrap; margin: 10px 0 0; }
    iframe { display:none; }
  </style>
</head>
<body>
  <h1>Перевод RUB → CNY и отправка в таблицу</h1>

  <div class="box">
    <div class="row">
      <label>
        name
        <input id="surname" type="text" value="Kirill Koryaushkin" />
      </label>

      <label>
        Сумма в рублях
        <input id="rub" type="number" step="0.01" value="123" />
      </label>
    </div>

    <label>
      Источник курса
      <select id="rateSource">
        <option value="mirror">Зеркало курсов</option>
      </select>
    </label>

    <button id="sendBtn">Посчитать и отправить</button>
  </div>

  <div class="box">
    <strong>Результат</strong>
    <pre id="out">—</pre>
  </div>

  <iframe name="hidden_iframe" id="hidden_iframe"></iframe>

<script>
  const FORM_ACTION_URL =
    "https://docs.google.com/forms/d/e/1FAIpQLSc_sJpZ-t2y-Mt_HsDADgh4-et7OGLGFqZNXseLRQlGwciWoQ/formResponse";

  const ENTRY_SURNAME = "entry.138719531";
  const ENTRY_AMOUNT_CNY = "entry.1949578643";

  const MIRROR_XML_URL = "https://www.cbr-xml-daily.ru/daily_utf8.xml";

  function parseCnyRateFromCbrXml(xmlText) {
    const doc = new DOMParser().parseFromString(xmlText, "text/xml");
    const valutes = Array.from(doc.querySelectorAll("Valute"));
    const cny = valutes.find(v => (v.querySelector("CharCode")?.textContent || "").trim() === "CNY");

    const nominal = Number((cny.querySelector("Nominal")?.textContent || "1").trim());
    const valueStr = (cny.querySelector("Value")?.textContent || "").trim();
    const valueRub = Number(valueStr.replace(",", "."));
    if (!Number.isFinite(nominal) || !Number.isFinite(valueRub) || nominal <= 0) throw new Error("Курс CNY не распарсился");

    return valueRub / nominal;
  }

  async function getCnyRateRubPer1Cny() {
    const resp = await fetch(MIRROR_XML_URL, { cache: "no-store" });
    if (!resp.ok) throw new Error(`Курс не получен: HTTP ${resp.status}`);
    return parseCnyRateFromCbrXml(await resp.text());
  }

  function submitViaHiddenForm(surname, amountCny) {
    const old = document.getElementById("gform_hidden");
    if (old) old.remove();

    const form = document.createElement("form");
    form.id = "gform_hidden";
    form.method = "POST";
    form.action = FORM_ACTION_URL;
    form.target = "hidden_iframe";
    form.style.display = "none";

    const i1 = document.createElement("input");
    i1.type = "hidden";
    i1.name = ENTRY_SURNAME;
    i1.value = surname;

    const i2 = document.createElement("input");
    i2.type = "hidden";
    i2.name = ENTRY_AMOUNT_CNY;
    i2.value = String(amountCny);

    form.appendChild(i1);
    form.appendChild(i2);
    document.body.appendChild(form);
    form.submit();
  }

  document.getElementById("sendBtn").addEventListener("click", async () => {
    const out = document.getElementById("out");
    out.textContent = "Работаю...";

    const surname = (document.getElementById("surname").value || "").trim();
    const rub = Number((document.getElementById("rub").value || "").trim());

    if (!surname) { out.textContent = "Ошибка: пустое имя."; return; }
    if (!Number.isFinite(rub) || rub <= 0) { out.textContent = "Ошибка: сумма RUB должна быть > 0."; return; }

    try {
      const rubPer1Cny = await getCnyRateRubPer1Cny();
      const cny = rub / rubPer1Cny;
      const cnyToSend = Number(cny).toFixed(6);

      submitViaHiddenForm(surname, cnyToSend);

      out.textContent =
        `Отправлено.\n` +
        `1 CNY = ${rubPer1Cny.toFixed(6)} RUB\n` +
        `RUB: ${rub.toFixed(2)}\n` +
        `CNY: ${cnyToSend}\n`;
    } catch (e) {
      out.textContent = `Ошибка: ${e?.message || e}`;
    }
  });
</script>
</body>
</html>